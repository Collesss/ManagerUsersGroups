using AutoMapper;
using ManagerUsersGroups.Repository.LDAP.AutoMapperProfiles;
using ManagerUsersGroups.Repository.LDAP.Implementations;
using ManagerUsersGroups.Repository.Entities;
using ManagerUsersGroups.Repository.Interfaces;
using System.DirectoryServices.Protocols;
using Microsoft.Extensions.Options;
using ManagerUsersGroups.Repository.LDAP.Options;
using Moq;

namespace ManagerUsersGroups.Tests
{
    [TestClass]
    public class RepositoryLDAPUnitTest
    {
        [TestMethod]
        public void TestGetBySid()
        {
            #region arrange
            IMapper mapper = new MapperConfiguration(cfg => cfg.AddProfile<AutoMapperProfile>()).CreateMapper();

            LDAPOptions options = new LDAPOptions { SearchRoot = string.Empty };
            Mock<IOptionsSnapshot<LDAPOptions>> mockOptions = new Mock<IOptionsSnapshot<LDAPOptions>>();
            mockOptions
            .Setup(opts => opts.Value)
                .Returns(options);


            Mock<SearchResultEntry> mockSearchResultEntry = new Mock<SearchResultEntry>();
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["objectSid"][0])
                    .Returns(new byte[] { 0x01, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x15, 0x00, 0x00, 0x00, 0x11, 0x74, 0xF6, 0xA9, 0x71, 0x33, 0xD6, 0x70, 0x01, 0x07, 0x73, 0xF9, 0xF5, 0x10, 0x00, 0x00 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["sAMAccountName"][0])
                    .Returns(new byte[] { 0x6c, 0x65, 0x73, 0x69, 0x6b, 0x6f, 0x76 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["displayName"][0])
                    .Returns(new byte[] { 0xd0, 0x9b, 0xd0, 0xb5, 0xd1, 0x81, 0xd0, 0xb8, 0xd0, 0xba, 0xd0, 0xbe, 0xd0, 0xb2, 0x20, 0xd0, 0xa1, 0xd0, 0xb5, 0xd1, 0x80, 0xd0, 0xb3, 0xd0, 0xb5, 0xd0, 0xb9, 0x20, 0xd0, 0x98, 0xd0, 0xb3, 0xd0, 0xbe, 0xd1, 0x80, 0xd0, 0xb5, 0xd0, 0xb2, 0xd0, 0xb8, 0xd1, 0x87 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["mail"][0])
                    .Returns(new byte[] { 0x6c, 0x65, 0x73, 0x69, 0x6b, 0x6f, 0x76, 0x40, 0x63, 0x72, 0x6f, 0x63, 0x75, 0x73, 0x67, 0x72, 0x6f, 0x75, 0x70, 0x2e, 0x72, 0x75 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["sAMAccountName"][0])
                    .Returns(new byte[] { 0x6c, 0x65, 0x73, 0x69, 0x6b, 0x6f, 0x76 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["cn"][0])
                    .Returns(new byte[] { 0xd0, 0x9b, 0xd0, 0xb5, 0xd1, 0x81, 0xd0, 0xb8, 0xd0, 0xba, 0xd0, 0xbe, 0xd0, 0xb2, 0x20, 0xd0, 0xa1, 0xd0, 0xb5, 0xd1, 0x80, 0xd0, 0xb3, 0xd0, 0xb5, 0xd0, 0xb9, 0x20, 0xd0, 0x98, 0xd0, 0xb3, 0xd0, 0xbe, 0xd1, 0x80, 0xd0, 0xb5, 0xd0, 0xb2, 0xd0, 0xb8, 0xd1, 0x87 });
            mockSearchResultEntry
                .Setup(mock => mock.Attributes["distinguishedName"][0])
                    .Returns(new byte[] { 0x43, 0x4e, 0x3d, 0xd0, 0x9b, 0xd0, 0xb5, 0xd1, 0x81, 0xd0, 0xb8, 0xd0, 0xba, 0xd0, 0xbe, 0xd0, 0xb2, 0x20, 0xd0, 0xa1, 0xd0, 0xb5, 0xd1, 0x80, 0xd0, 0xb3, 0xd0, 0xb5, 0xd0, 0xb9, 0x20, 0xd0, 0x98, 0xd0, 0xb3, 0xd0, 0xbe, 0xd1, 0x80, 0xd0, 0xb5, 0xd0, 0xb2, 0xd0, 0xb8, 0xd1, 0x87, 0x2c, 0x4f, 0x55, 0x3d, 0x56, 0x45, 0x32, 0x2c, 0x4f, 0x55, 0x3d, 0x50, 0x65, 0x72, 0x73, 0x6f, 0x6e, 0x61, 0x6c, 0x20, 0x61, 0x63, 0x63, 0x6f, 0x75, 0x6e, 0x74, 0x73, 0x2c, 0x4f, 0x55, 0x3d, 0x54, 0x65, 0x63, 0x68, 0x5f, 0x73, 0x75, 0x70, 0x70, 0x6f, 0x72, 0x74, 0x2c, 0x44, 0x43, 0x3d, 0x6f, 0x66, 0x66, 0x69, 0x63, 0x65, 0x2c, 0x44, 0x43, 0x3d, 0x63, 0x72, 0x6f, 0x63, 0x75, 0x73, 0x67, 0x72, 0x6f, 0x75, 0x70, 0x2c, 0x44, 0x43, 0x3d, 0x72, 0x75 });


            Mock<SearchResultEntryCollection> mockSearchResultEntryCollection = new Mock<SearchResultEntryCollection>();
            mockSearchResultEntryCollection
                .Setup(mock => mock.Cast<SearchResultEntry>())
                    .Returns(new List<SearchResultEntry>() { mockSearchResultEntry.Object });

            Mock<SearchResponse> mockSearchResponse = new Mock<SearchResponse>();
            mockSearchResponse
                .Setup(reponse => reponse.ResultCode)
                    .Returns(ResultCode.Success);
            mockSearchResponse
                .Setup(response => response.Entries)
                    .Returns(mockSearchResultEntryCollection.Object);

            Mock<DirectoryConnection> mockConn = new Mock<DirectoryConnection>();
            mockConn
                .Setup(conn => conn.SendRequest(It.IsAny<DirectoryRequest>()))
                    .Returns(mockSearchResponse.Object);

            DirectoryConnection connection = new LdapConnection("office.crocusgroup.ru");

            /*
            Mock<DirectoryConnection> mockConnection = new Mock<DirectoryConnection>();
            mockConnection
                .Setup(conn => conn.SendRequest(It.IsAny<DirectoryRequest>()) == new DirectoryResponse() { };
            */

            IUserRepository userRepository = new UserRepository(mapper, connection, mockOptions.Object);
            
            string sid = "S-1-5-21-2851501073-1893086065-4185065217-4341";
            #endregion

            #region act
            UserEntity user = userRepository.GetBySID(sid).Result;
            #endregion

            #region assert
            Assert.AreEqual(sid, user.SID);
            #endregion
        }
    }
}
